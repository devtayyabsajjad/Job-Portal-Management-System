{% extends 'base.html' %}
{% load static %}

{% block title %}Browse Jobs - Job Portal{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Filter Sidebar -->
        <div class="col-lg-3 mb-4">
            <div class="filter-sidebar">
                <h5><i class="fas fa-filter"></i> Filters</h5>
                <form method="get" action="{% url 'job_list' %}">
                    <!-- Keyword Search -->
                    <div class="form-group mb-3">
                        <label for="keyword" class="form-label">Keywords</label>
                        <input type="text" 
                               class="form-control" 
                               id="keyword" 
                               name="keyword" 
                               placeholder="Job title, keywords..."
                               value="{{ form.keyword.value|default:'' }}">
                    </div>

                    <!-- Location -->
                    <div class="form-group mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" 
                               class="form-control" 
                               id="location" 
                               name="location" 
                               placeholder="City or location"
                               value="{{ form.location.value|default:'' }}">
                    </div>

                    <!-- Job Type -->
                    <div class="form-group mb-3">
                        <label for="employment_type" class="form-label">Job Type</label>
                        <select class="form-select" id="employment_type" name="employment_type">
                            <option value="">All Types</option>
                            <option value="full-time" {% if form.employment_type.value == 'full-time' %}selected{% endif %}>Full Time</option>
                            <option value="part-time" {% if form.employment_type.value == 'part-time' %}selected{% endif %}>Part Time</option>
                            <option value="contract" {% if form.employment_type.value == 'contract' %}selected{% endif %}>Contract</option>
                            <option value="internship" {% if form.employment_type.value == 'internship' %}selected{% endif %}>Internship</option>
                        </select>
                    </div>

                    <!-- Experience Level -->
                    <div class="form-group mb-3">
                        <label for="experience" class="form-label">Experience</label>
                        <select class="form-select" id="experience" name="experience">
                            <option value="">Any Experience</option>
                            <option value="0-1" {% if form.experience.value == '0-1' %}selected{% endif %}>0-1 years</option>
                            <option value="1-3" {% if form.experience.value == '1-3' %}selected{% endif %}>1-3 years</option>
                            <option value="3-5" {% if form.experience.value == '3-5' %}selected{% endif %}>3-5 years</option>
                            <option value="5+" {% if form.experience.value == '5+' %}selected{% endif %}>5+ years</option>
                        </select>
                    </div>

                    <!-- Category -->
                    <div class="form-group mb-3">
                        <label for="category" class="form-label">Category</label>
                        <input type="text" 
                               class="form-control" 
                               id="category" 
                               name="category" 
                               placeholder="e.g., Security Guard"
                               value="{{ form.category.value|default:'' }}">
                    </div>

                    <!-- Sort By -->
                    <div class="form-group mb-3">
                        <label for="sort_by" class="form-label">Sort By</label>
                        <select class="form-select" id="sort_by" name="sort_by">
                            <option value="-created_at" {% if form.sort_by.value == '-created_at' %}selected{% endif %}>Newest First</option>
                            <option value="created_at" {% if form.sort_by.value == 'created_at' %}selected{% endif %}>Oldest First</option>
                            <option value="title" {% if form.sort_by.value == 'title' %}selected{% endif %}>Title A-Z</option>
                            <option value="-title" {% if form.sort_by.value == '-title' %}selected{% endif %}>Title Z-A</option>
                        </select>
                    </div>

                    <!-- Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <a href="{% url 'job_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-redo"></i> Clear All
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Job Listings -->
        <div class="col-lg-9">
            <!-- Results Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">Available Jobs</h2>
                    <p class="text-muted mb-0">
                        {% if total_results %}
                            Showing {{ jobs.start_index }}-{{ jobs.end_index }} of {{ total_results }} jobs
                        {% else %}
                            No jobs found
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Job Cards -->
            {% if jobs %}
                {% for job in jobs %}
                <div class="job-card">
                    <div class="row align-items-start">
                        <div class="col-auto">
                            {% if job.company.company_logo %}
                            <img src="{{ job.company.company_logo.url }}" 
                                 alt="{{ job.company.name }}" 
                                 class="company-logo">
                            {% else %}
                            <div class="company-logo d-flex align-items-center justify-content-center bg-light">
                                <i class="fas fa-building fa-2x text-muted"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="job-title mb-1">
                                        <a href="{% url 'job_detail' job.id %}" class="text-decoration-none">
                                            {{ job.title }}
                                        </a>
                                    </h5>
                                    <p class="company-name mb-0">{{ job.company.name }}</p>
                                </div>
                                <div>
                                    {% if user.is_authenticated and user.user_type == 'jobseeker' %}
                                        {% if job.id in user.saved_jobs.all %}
                                        <button class="btn btn-success btn-sm save-job-btn saved" 
                                                data-job-id="{{ job.id }}">
                                            <i class="fas fa-heart"></i> Saved
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-primary btn-sm save-job-btn" 
                                                data-job-id="{{ job.id }}">
                                            <i class="far fa-heart"></i> Save
                                        </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="job-meta">
                                <span>
                                    <i class="fas fa-map-marker-alt"></i> {{ job.city }}
                                </span>
                                <span>
                                    <i class="fas fa-clock"></i> {{ job.get_employment_type_display }}
                                </span>
                                <span>
                                    <i class="fas fa-briefcase"></i> {{ job.get_experience_required_display }}
                                </span>
                                {% if job.salary_min and job.salary_max %}
                                <span>
                                    <i class="fas fa-dollar-sign"></i> 
                                    ${{ job.salary_min|floatformat:0 }} - ${{ job.salary_max|floatformat:0 }}
                                </span>
                                {% endif %}
                            </div>

                            <p class="text-muted mb-3">
                                {{ job.description|truncatewords:30 }}
                            </p>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-primary">{{ job.category }}</span>
                                    <small class="text-muted ms-2">
                                        <i class="fas fa-eye"></i> {{ job.views_count }} views
                                    </small>
                                </div>
                                <div>
                                    <small class="text-muted">Posted {{ job.created_at|timesince }} ago</small>
                                    <a href="{% url 'job_detail' job.id %}" class="btn btn-primary btn-sm ms-2">
                                        View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Pagination -->
                {% if jobs.has_other_pages %}
                <nav aria-label="Job pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if jobs.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ jobs.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                Page {{ jobs.number }} of {{ jobs.paginator.num_pages }}
                            </span>
                        </li>

                        {% if jobs.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ jobs.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ jobs.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            {% else %}
                <!-- No Jobs Found -->
                <div class="text-center py-5">
                    <i class="fas fa-search fa-4x text-muted mb-3"></i>
                    <h3>No jobs found</h3>
                    <p class="text-muted">Try adjusting your search filters</p>
                    <a href="{% url 'job_list' %}" class="btn btn-primary">Clear Filters</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Add CSRF token to save job AJAX requests

    // Get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Example: Setup CSRF for all AJAX requests with Fetch
    function csrfSafeMethod(method) {
        // HTTP methods that do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    // Usage example:
    // fetch('/some/url/', {
    //     method: 'POST',
    //     headers: {
    //         'X-CSRFToken': csrftoken,
    //         'Content-Type': 'application/json'
    //     },
    //     body: JSON.stringify(data)
    // })

</script>
</script>
{% endblock %}
